{% comment %}
  AONA Customer Dashboard (Profile)
  Includes: Orders, Addresses, Wishlist, Cart Preview, and Recently Viewed
{% endcomment %}

<div class="account-dashboard">
  <!-- 1. Header Profile Info -->
  <div class="account-header">
    <div class="user-avatar">
      {% if customer.first_name %}
        {{ customer.first_name | slice: 0 | upcase }}
      {% else %}
        {{ customer.email | slice: 0 | upcase }}
      {% endif %}
    </div>
    <div class="user-greeting">
      <h1 class="namaste-text">Namaste, {{ customer.first_name | default: 'Guest' }}</h1>
      <p class="user-contact">{{ customer.email }}</p>
    </div>
  </div>

  <!-- 2. My Orders Section -->
  <div class="account-list-group">
    <div class="group-title">My Orders</div>
    <div class="orders-container">
      {% if customer.orders.size == 0 %}
        <div class="orders-empty-state">
          <div class="empty-icon-wrap">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#D4AF37" stroke-width="1.5">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
          </div>
          <h3>No Orders Yet</h3>
          <p>You haven't started your artisan collection yet.</p>
          <a href="{{ routes.all_products_collection_url }}" class="start-shopping-btn">Start Shopping</a>
        </div>
      {% else %}
        <div class="orders-list">
          {% for order in customer.orders limit: 5 %}
            <div class="order-card">
              <div class="order-card-header">
                <div class="order-info">
                  <span class="order-number">Order {{ order.name }}</span>
                  <span class="order-date">{{ order.created_at | date: "%b %d, %Y" }}</span>
                </div>
                <div class="order-status {% if order.fulfillment_status == 'fulfilled' %}status-green{% else %}status-orange{% endif %}">
                  {{ order.fulfillment_status_label | default: 'Unfulfilled' }}
                </div>
              </div>
              <div class="order-card-body">
                <span class="order-total">{{ order.total_price | money }}</span>
                <a href="{{ order.customer_url }}" class="view-details-btn">View Details &rarr;</a>
              </div>
            </div>
          {% endfor %}
          {% if customer.orders.size > 5 %}
            <a href="{{ routes.account_url }}?page=2" class="view-all-orders">View All Orders</a>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- 3. Account Settings & Wishlist -->
  <div class="account-list-group">
    <div class="group-title">My Account</div>
    
    <!-- Wishlist Link -->
    <a href="/pages/wishlist" class="list-item">
      <div class="list-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </div>
      <span class="list-label">My Wishlist</span>
      <div class="list-arrow">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </div>
    </a>

    <!-- Addresses Link -->
    <a href="{{ routes.account_addresses_url }}" class="list-item">
      <div class="list-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
      </div>
      <span class="list-label">Saved Addresses</span>
      <div class="list-arrow">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
      </div>
    </a>
  </div>

  <!-- 4. Currently in Cart -->
  <div class="account-list-group">
    <div class="group-title">Currently in your Bag</div>
    <div class="cart-preview-container">
      {% if cart.item_count > 0 %}
        <div class="cart-preview-grid">
          {% for item in cart.items limit: 4 %}
            <a href="{{ item.url }}" class="cart-preview-item">
              <img src="{{ item.image | image_url: width: 200 }}" alt="{{ item.title | escape }}">
              <div class="cp-info">
                <p class="cp-title">{{ item.product.title | truncate: 25 }}</p>
                <p class="cp-price">{{ item.final_line_price | money }}</p>
              </div>
            </a>
          {% endfor %}
        </div>
        <a href="{{ routes.cart_url }}" class="view-cart-btn">Go to Cart ({{ cart.item_count }} items) &rarr;</a>
      {% else %}
        <div style="padding: 10px 0; text-align: center;">
          <p class="empty-msg">Your bag is currently empty.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- 5. Recently Viewed (Loaded via JS) -->
  <div class="account-list-group" id="recent-views-section" style="display: none;">
    <div class="group-title">Recently Viewed</div>
    <div class="recent-preview-grid" id="recently-viewed-grid">
      <!-- Items injected here by Javascript -->
    </div>
  </div>

  <!-- 6. Support -->
  <div class="account-list-group">
    <div class="group-title">Support</div>
    {%- assign clean_whatsapp_num = settings.whatsapp_number | default: '919310069721' | remove: ' ' | remove: '+' | remove: '-' -%}
    <a href="https://wa.me/{{ clean_whatsapp_num }}" class="list-item" target="_blank">
      <div class="list-icon" style="color: #25D366;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347"/>
        </svg>
      </div>
      <span class="list-label">WhatsApp Support</span>
      <div class="list-arrow"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
    </a>
  </div>

  <!-- 7. Logout -->
  <div class="account-footer">
    <a href="{{ routes.account_logout_url }}" class="logout-btn">Log Out</a>
  </div>
</div>

<style>
/* Dashboard Styles */
.account-dashboard { background-color: #FAFAFA; min-height: 100vh; padding-bottom: 60px; max-width: 800px; margin: 0 auto; }
.account-dashboard h1, .account-dashboard h3 { font-family: 'Playfair Display', serif; margin: 0; line-height: 1.2; }
.account-header { background: white; padding: 40px 20px 30px; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid #EEEEEE; }
.user-avatar { width: 65px; height: 65px; background: #fdf5f6; color: #880015; font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #f0e6e7; }
.namaste-text { font-size: 22px; color: #1a1a1a; margin-bottom: 4px; }
.user-contact { font-size: 14px; color: #666; margin: 0;}
.account-list-group { margin-top: 16px; background: white; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
.group-title { padding: 20px 20px 10px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; font-weight: 700; }

/* Orders Area */
.orders-container { padding: 0 20px 20px; }
.orders-empty-state { text-align: center; padding: 30px 0; background: #fdfdfd; border: 1px dashed #ddd; border-radius: 8px; }
.empty-icon-wrap { margin-bottom: 12px; }
.orders-empty-state h3 { font-size: 18px; color: #333; margin-bottom: 8px; }
.orders-empty-state p { font-size: 14px; color: #888; margin-bottom: 20px; }
.start-shopping-btn { display: inline-block; background: #880015; color: white; padding: 10px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; transition: background 0.2s; }
.start-shopping-btn:hover { background: #60000e; }
.orders-list { display: flex; flex-direction: column; gap: 12px; }
.order-card { border: 1px solid #eee; border-radius: 8px; padding: 16px; background: #fff; transition: box-shadow 0.2s; }
.order-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.order-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f9f9f9; }
.order-info { display: flex; flex-direction: column; }
.order-number { font-weight: 700; color: #1a1a1a; font-size: 14px; }
.order-date { font-size: 12px; color: #888; margin-top: 2px; }
.order-status { font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }
.status-green { background: #e8f5e9; color: #2e7d32; }
.status-orange { background: #fff3e0; color: #ef6c00; }
.order-card-body { display: flex; justify-content: space-between; align-items: center; }
.order-total { font-size: 16px; font-weight: 700; color: #880015; }
.view-details-btn { font-size: 13px; color: #333; text-decoration: none; font-weight: 600; }
.view-details-btn:hover { color: #880015; text-decoration: underline; }
.view-all-orders { display: block; text-align: center; margin-top: 12px; font-size: 13px; font-weight: 600; color: #880015; text-decoration: underline; }

/* List Items (Addresses, Wishlist, Support) */
.list-item { display: flex; align-items: center; gap: 16px; padding: 16px 20px; border-bottom: 1px solid #f5f5f5; text-decoration: none; transition: background 0.2s; }
.list-item:hover { background-color: #fafafa; }
.list-item:last-child { border-bottom: none; }
.list-icon { color: #880015; }
.list-label { flex: 1; font-size: 14px; font-weight: 500; color: #333; }
.list-arrow { color: #ccc; }

/* Cart & Recent Preview */
.cart-preview-container { padding: 0 20px 20px; }
.cart-preview-grid, .recent-preview-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); 
  gap: 12px; 
  margin-bottom: 16px; 
  padding: 0 20px 20px;
}
.cart-preview-item { border: 1px solid #eee; border-radius: 8px; overflow: hidden; text-decoration: none; display: block; transition: box-shadow 0.2s; }
.cart-preview-item:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
.cart-preview-item img { width: 100%; aspect-ratio: 1; object-fit: contain; background: #f9f9f9; padding: 8px; }
.cp-info { padding: 10px; border-top: 1px solid #f5f5f5; }
.cp-title { font-size: 12px; color: #333; margin: 0 0 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500;}
.cp-price { font-size: 13px; font-weight: 700; color: #880015; margin: 0; }
.view-cart-btn { display: block; text-align: center; color: #880015; font-size: 13px; font-weight: 600; text-decoration: none; padding: 12px; background: #fff5f5; border-radius: 6px; transition: background 0.2s;}
.view-cart-btn:hover { background: #ffebeb; }
.empty-msg { font-size: 14px; color: #888; font-style: italic; }

/* Footer */
.account-footer { padding: 40px 20px; text-align: center; }
.logout-btn { display: block; width: 100%; max-width: 300px; margin: 0 auto; padding: 14px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; font-weight: 600; color: #d32f2f; background: white; text-decoration: none; transition: background 0.2s; }
.logout-btn:hover { background: #fdf5f5; border-color: #d32f2f; }
</style>

<script>
// Fetch and Display Recently Viewed Items
document.addEventListener('DOMContentLoaded', function() {
  const recentGrid = document.getElementById('recently-viewed-grid');
  const recentSection = document.getElementById('recent-views-section');
  
  if(!recentGrid || !recentSection) return;

  // Read the handles from local storage
  let recentHandles = JSON.parse(localStorage.getItem('aona_recently_viewed') || '[]');
  
  if(recentHandles.length > 0) {
    recentSection.style.display = 'block';
    
    // Limit to the 4 most recent items
    recentHandles.slice(0, 4).forEach(handle => {
      fetch(`/products/${handle}.js`)
        .then(res => res.json())
        .then(product => {
          // Shopify returns price in cents, format it to Rupees
          const price = (product.price / 100).toLocaleString('en-IN');
          
          const itemHtml = `
            <a href="${product.url}" class="cart-preview-item">
              <img src="${product.featured_image}" alt="${product.title}">
              <div class="cp-info">
                <p class="cp-title">${product.title}</p>
                <p class="cp-price">â‚¹${price}</p>
              </div>
            </a>
          `;
          recentGrid.insertAdjacentHTML('beforeend', itemHtml);
        })
        .catch(err => console.log('Product no longer exists or error fetching', err));
    });
  }
});
</script>

{% schema %}
{
  "name": "Customer Profile",
  "settings": []
}
{% endschema %}