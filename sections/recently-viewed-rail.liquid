{% schema %}
{
  "name": "Recently Viewed Rail",
  "settings": [],
  "presets": [{ "name": "Recently Viewed Rail" }]
}
{% endschema %}

<div id="rv-rail-container" class="rv-rail-hidden">
  <div class="rv-header">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
    </svg>
    <span>Recently Viewed</span>
  </div>
  <div class="rv-product-list" id="rv-grid">
    <!-- Products injected via JS -->
  </div>
</div>

<style>
/* Base State */
#rv-rail-container { display: none; }
.rv-rail-hidden { display: none !important; }

.rv-header { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 12px; }
.rv-header svg { color: #880015; }

.rv-product-list { display: flex; gap: 12px; overflow-x: auto; scrollbar-width: none; padding-bottom: 10px; }
.rv-product-list::-webkit-scrollbar { display: none; }

.rv-item { flex: 0 0 100px; text-decoration: none; display: flex; flex-direction: column; gap: 6px; }
.rv-item-img { width: 100%; aspect-ratio: 1; border-radius: 8px; border: 1px solid #eee; object-fit: contain; background: #fff; padding: 4px; }
.rv-item-title { font-size: 11px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
.rv-item-price { font-size: 12px; font-weight: 700; color: #880015; }

/* =========================================
   MOBILE: Standard Section Placement
   ========================================= */
@media (max-width: 991px) {
  #rv-rail-container.rv-rail-visible {
    display: block;
    padding: 24px 16px;
    background: white;
    border-top: 5px solid #f5f5f6;
  }
}

/* =========================================
   DESKTOP: Floating Sticky Rail
   ========================================= */
@media (min-width: 992px) {
  #rv-rail-container.rv-rail-visible {
    display: flex;
    flex-direction: column;
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    border: 1px solid #eee;
    z-index: 999;
    max-width: 380px;
    transform: translateY(calc(100% - 50px)); /* Peeks out */
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Hover to pop up */
  #rv-rail-container.rv-rail-visible:hover {
    transform: translateY(0);
  }

  .rv-header { margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; justify-content: center; }
  
  .rv-item { transition: transform 0.2s; }
  .rv-item:hover { transform: translateY(-3px); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('rv-rail-container');
  const grid = document.getElementById('rv-grid');
  
  if (!container || !grid) return;

  // Fetch handles from local storage (saved when user visits a product page)
  let recentHandles = JSON.parse(localStorage.getItem('aona_recently_viewed') || '[]');
  
  // If we have history, build the UI
  if (recentHandles.length > 0) {
    // Only show up to 3 products in the rail to keep it neat
    const handlesToFetch = recentHandles.slice(0, 3);
    
    handlesToFetch.forEach(handle => {
      fetch(`/products/${handle}.js`)
        .then(res => res.json())
        .then(product => {
          const price = (product.price / 100).toLocaleString('en-IN');
          const imgUrl = product.featured_image ? product.featured_image : '';
          
          const itemHtml = `
            <a href="${product.url}" class="rv-item">
              <img src="${imgUrl}" alt="${product.title}" class="rv-item-img">
              <span class="rv-item-title">${product.title}</span>
              <span class="rv-item-price">â‚¹${price}</span>
            </a>
          `;
          grid.insertAdjacentHTML('beforeend', itemHtml);
        })
        .catch(e => console.log('Product fetch error', e));
    });

    // Make the rail visible
    container.classList.remove('rv-rail-hidden');
    container.classList.add('rv-rail-visible');
  }
});
</script>