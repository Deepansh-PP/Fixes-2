{% comment %}
  Main Search Results Section
  Uses Crimson Grid System with Universal Product Cards
  Features: Search Suggestions, Filter Bar, Infinite Scroll, No Results Carousel
{% endcomment %}

{{ 'crimson-grid.css' | asset_url | stylesheet_tag }}

<div class="search-page search-results">

  
  <!-- Search Header -->
  <div class="search-header">
    <form action="{{ routes.search_url }}" method="get" class="search-form">
      <div class="search-form__input-wrapper">
        <svg class="search-form__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input 
          type="search" 
          name="q" 
          id="searchInput"
          class="search-form__input" 
          value="{{ search.terms | escape }}"
          placeholder="{{ 'search.placeholder' | t | default: 'Search for brass, resin, statues...' }}"
          autocomplete="off"
        >
        {%- if search.terms != blank -%}
          <button type="button" class="search-form__clear" onclick="clearSearch()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
          </button>
        {%- endif -%}
      </div>
      <input type="hidden" name="type" value="product">
      
      <!-- Search Suggestions Dropdown -->
      <div class="search-suggestions" id="searchSuggestions">
        <div class="search-suggestions__section">
          <h4 class="search-suggestions__title">Popular Searches</h4>
          <div class="search-suggestions__list">
            <a href="{{ routes.search_url }}?q=brass+krishna&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Brass Krishna
            </a>
            <a href="{{ routes.search_url }}?q=copper+ganesha&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Copper Ganesha
            </a>
            <a href="{{ routes.search_url }}?q=resin+horse&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Resin Horse
            </a>
            <a href="{{ routes.search_url }}?q=wall+art&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Wall Art
            </a>
            <a href="{{ routes.search_url }}?q=brass+buddha&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Brass Buddha
            </a>
            <a href="{{ routes.search_url }}?q=metal+lamps&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Metal Lamps
            </a>
            <a href="{{ routes.search_url }}?q=home+decor&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Home Decor
            </a>
            <a href="{{ routes.search_url }}?q=antique+statue&type=product" class="search-suggestions__item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
              Antique Statue
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>

  {%- if search.performed -%}
    {%- if search.results_count > 0 -%}
      <!-- Results Header -->
      <div class="search-results-header">
        <p class="search-results-header__count">
          Showing <strong>{{ search.results_count }}</strong> results for "<strong>{{ search.terms }}</strong>"
        </p>
      </div>

      <!-- Sticky Filter Bar -->
      <div class="filter-bar--crimson" id="filterBar">
        <button type="button" class="filter-bar__item filter-bar__item--sort" onclick="openSortPanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="6" x2="16" y2="6"/>
            <line x1="4" y1="12" x2="12" y2="12"/>
            <line x1="4" y1="18" x2="8" y2="18"/>
          </svg>
          <span>Sort</span>
        </button>
        
        <button type="button" class="filter-bar__item" onclick="openFilterPanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"/>
          </svg>
          <span>Filter</span>
        </button>
        
        <div class="filter-bar__categories">
          <button type="button" class="filter-bar__category" data-search="brass">Brass</button>
          <button type="button" class="filter-bar__category" data-search="resin">Resin</button>
          <button type="button" class="filter-bar__category" data-search="copper">Copper</button>
          <button type="button" class="filter-bar__category" data-search="statues">Statues</button>
        </div>
      </div>

      <!-- Product Grid -->
      {%- paginate search.results by 12 -%}
        <div class="product-grid--crimson" id="productGrid">
          {%- for product in search.results -%}
            {%- if product.object_type == 'product' -%}
              {% render 'crimson-card', product: product, card_index: forloop.index %}
            {%- endif -%}
          {%- endfor -%}
        </div>

        <!-- Load More Button -->
        {%- if paginate.pages > 1 -%}
          <div class="load-more--crimson" id="loadMoreContainer">
            {%- if paginate.next -%}
              <button 
                type="button" 
                class="load-more__btn" 
                id="loadMoreBtn"
                data-next-url="{{ paginate.next.url }}"
              >
                <span class="load-more__text">Load More Results</span>
                <span class="load-more__spinner" style="display: none;"></span>
              </button>
            {%- else -%}
              <p class="load-more__end">You've seen all results</p>
            {%- endif -%}
          </div>
        {%- endif -%}
      {%- endpaginate -%}

    {%- else -%}
      <!-- No Results Found -->
      <div class="no-results--crimson">
        <svg class="no-results__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
          <line x1="8" y1="11" x2="14" y2="11"/>
        </svg>
        <h3 class="no-results__title">No results for "{{ search.terms }}"</h3>
        <p class="no-results__message">Try searching for something else or browse our categories</p>
        
        <!-- Try Searching Tags -->
        <div class="no-results__suggestions">
          <p class="no-results__suggestions-label">Try searching for:</p>
          <div class="no-results__tags">
            <a href="{{ routes.search_url }}?q=brass+ganesha&type=product" class="no-results__tag">Brass Ganesha</a>
            <a href="{{ routes.search_url }}?q=resin+statue&type=product" class="no-results__tag">Resin Statue</a>
            <a href="{{ routes.search_url }}?q=wall+art&type=product" class="no-results__tag">Wall Art</a>
            <a href="{{ routes.search_url }}?q=buddha&type=product" class="no-results__tag">Buddha</a>
            <a href="{{ routes.search_url }}?q=krishna&type=product" class="no-results__tag">Krishna</a>
          </div>
        </div>
        
        <!-- Trending Products Carousel -->
        <div class="no-results__trending">
          <h4 class="no-results__trending-title">Trending Brass & Resin</h4>
          <div class="no-results__carousel">
            {%- for product in collections['all'].products limit: 10 -%}
              {% render 'crimson-card', product: product, show_quick_add: false %}
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- endif -%}

  {%- else -%}
    <!-- Initial Search State -->
    <div class="search-initial">
      <div class="search-initial__popular">
        <h3 class="search-initial__title">Popular Searches</h3>
        <div class="search-initial__tags">
          <a href="{{ routes.search_url }}?q=brass+krishna&type=product" class="search-initial__tag">Brass Krishna</a>
          <a href="{{ routes.search_url }}?q=copper+ganesha&type=product" class="search-initial__tag">Copper Ganesha</a>
          <a href="{{ routes.search_url }}?q=resin+horse&type=product" class="search-initial__tag">Resin Horse</a>
          <a href="{{ routes.search_url }}?q=wall+art&type=product" class="search-initial__tag">Wall Art</a>
          <a href="{{ routes.search_url }}?q=brass+buddha&type=product" class="search-initial__tag">Brass Buddha</a>
          <a href="{{ routes.search_url }}?q=metal+lamps&type=product" class="search-initial__tag">Metal Lamps</a>
        </div>
      </div>
      
      <div class="search-initial__categories">
        <h3 class="search-initial__title">Browse Categories</h3>
        <div class="search-initial__grid">
          {%- for collection in collections limit: 8 -%}
            {%- if collection.handle != 'all' -%}
              <a href="{{ collection.url }}" class="search-initial__category">
                {%- if collection.image -%}
                  <img src="{{ collection.image | image_url: width: 200 }}" alt="{{ collection.title }}" loading="lazy">
                {%- else -%}
                  <div class="search-initial__category-placeholder"></div>
                {%- endif -%}
                <span>{{ collection.title }}</span>
              </a>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>
    </div>
  {%- endif -%}

  <!-- Sort Panel -->
  <div class="sort-panel" id="sortPanel">
    <div class="sort-panel__overlay" onclick="closeSortPanel()"></div>
    <div class="sort-panel__content">
      <div class="sort-panel__header">
        <h3>Sort By</h3>
        <button type="button" class="sort-panel__close" onclick="closeSortPanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="sort-panel__options">
        <a href="{{ routes.search_url }}?q={{ search.terms }}&type=product&sort_by=relevance" class="sort-panel__option is-active">
          <span>Relevance</span>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20,6 9,17 4,12"/></svg>
        </a>
        <a href="{{ routes.search_url }}?q={{ search.terms }}&type=product&sort_by=price-ascending" class="sort-panel__option">
          <span>Price: Low to High</span>
        </a>
        <a href="{{ routes.search_url }}?q={{ search.terms }}&type=product&sort_by=price-descending" class="sort-panel__option">
          <span>Price: High to Low</span>
        </a>
        <a href="{{ routes.search_url }}?q={{ search.terms }}&type=product&sort_by=created-descending" class="sort-panel__option">
          <span>Newest First</span>
        </a>
        <a href="{{ routes.search_url }}?q={{ search.terms }}&type=product&sort_by=best-selling" class="sort-panel__option">
          <span>Best Selling</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" id="filterPanel">
    <div class="filter-panel__overlay" onclick="closeFilterPanel()"></div>
    <div class="filter-panel__content">
      <div class="filter-panel__header">
        <h3>Filters</h3>
        <button type="button" class="filter-panel__close" onclick="closeFilterPanel()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="filter-panel__body">
        <div class="filter-group is-open">
          <button type="button" class="filter-group__header">
            <span>Material</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg>
          </button>
          <div class="filter-group__options">
            <label class="filter-option">
              <input type="checkbox" value="brass"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">Brass</span>
            </label>
            <label class="filter-option">
              <input type="checkbox" value="copper"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">Copper</span>
            </label>
            <label class="filter-option">
              <input type="checkbox" value="resin"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">Resin</span>
            </label>
            <label class="filter-option">
              <input type="checkbox" value="bronze"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">Bronze</span>
            </label>
          </div>
        </div>
        <div class="filter-group">
          <button type="button" class="filter-group__header" onclick="this.closest('.filter-group').classList.toggle('is-open')">
            <span>Price Range</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"/></svg>
          </button>
          <div class="filter-group__options">
            <label class="filter-option">
              <input type="checkbox" value="0-5000"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">Under ₹5,000</span>
            </label>
            <label class="filter-option">
              <input type="checkbox" value="5000-10000"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">₹5,000 - ₹10,000</span>
            </label>
            <label class="filter-option">
              <input type="checkbox" value="10000-25000"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">₹10,000 - ₹25,000</span>
            </label>
            <label class="filter-option">
              <input type="checkbox" value="25000+"><span class="filter-option__checkbox"></span>
              <span class="filter-option__label">Above ₹25,000</span>
            </label>
          </div>
        </div>
      </div>
      <div class="filter-panel__footer">
        <button type="button" class="filter-panel__clear" onclick="clearFilters()">Clear All</button>
        <button type="button" class="filter-panel__apply" onclick="closeFilterPanel()">Apply Filters</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Search Page Styles */
.search-page {
  min-height: 100vh;
  background: #F5F5F6;
  padding-bottom: 80px;
}

/* Search Header */
.search-header {
  background: #fff;
  padding: 16px;
  position: sticky;
  top: 60px;
  z-index: 100;
  border-bottom: 1px solid #E8E8E8;
}

.search-form {
  position: relative;
}

.search-form__input-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: #F5F5F6;
  border-radius: 8px;
  border: 1px solid transparent;
  transition: all 0.2s;
}

.search-form__input-wrapper:focus-within {
  background: #fff;
  border-color: #A91D1D;
  box-shadow: 0 0 0 3px rgba(169, 29, 29, 0.1);
}

.search-form__icon {
  width: 20px;
  height: 20px;
  color: #666;
  flex-shrink: 0;
}

.search-form__input {
  flex: 1;
  border: none;
  background: none;
  font-size: 15px;
  color: #333;
  outline: none;
}

.search-form__input::placeholder {
  color: #999;
}

.search-form__clear {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  cursor: pointer;
  padding: 0;
}

.search-form__clear svg {
  width: 18px;
  height: 18px;
  color: #666;
}

/* Search Suggestions */
.search-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  display: none;
  z-index: 200;
  max-height: 400px;
  overflow-y: auto;
}

.search-form__input:focus ~ .search-suggestions,
.search-suggestions:hover {
  display: block;
}

.search-suggestions__section {
  padding: 16px;
}

.search-suggestions__title {
  margin: 0 0 12px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #999;
}

.search-suggestions__list {
  display: flex;
  flex-direction: column;
}

.search-suggestions__item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 8px;
  font-size: 14px;
  color: #333;
  text-decoration: none;
  border-radius: 8px;
  transition: background 0.2s;
}

.search-suggestions__item:hover {
  background: #FFF5F5;
  color: #A91D1D;
}

.search-suggestions__item svg {
  width: 16px;
  height: 16px;
  color: #CCC;
}

/* Search Results Header */
.search-results-header {
  background: #fff;
  padding: 12px 16px;
  border-bottom: 1px solid #E8E8E8;
}

.search-results-header__count {
  margin: 0;
  font-size: 13px;
  color: #666;
}

.search-results-header__count strong {
  color: #A91D1D;
}

/* No Results Suggestions */
.no-results__suggestions {
  margin: 24px 0;
}

.no-results__suggestions-label {
  font-size: 13px;
  color: #666;
  margin-bottom: 12px;
}

.no-results__tags {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
}

.no-results__tag {
  display: inline-block;
  padding: 8px 16px;
  font-size: 13px;
  color: #A91D1D;
  background: #FFF5F5;
  border: 1px solid #A91D1D;
  border-radius: 20px;
  text-decoration: none;
  transition: all 0.2s;
}

.no-results__tag:hover {
  background: #A91D1D;
  color: #fff;
}

/* Initial Search State */
.search-initial {
  padding: 20px 16px;
}

.search-initial__title {
  margin: 0 0 16px;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: #333;
}

.search-initial__popular {
  margin-bottom: 32px;
}

.search-initial__tags {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.search-initial__tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  font-size: 13px;
  color: #333;
  background: #fff;
  border: 1px solid #E8E8E8;
  border-radius: 20px;
  text-decoration: none;
  transition: all 0.2s;
}

.search-initial__tag:hover {
  border-color: #A91D1D;
  color: #A91D1D;
}

.search-initial__grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}

.search-initial__category {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  text-decoration: none;
}

.search-initial__category img,
.search-initial__category-placeholder {
  width: 100%;
  aspect-ratio: 1;
  object-fit: cover;
  border-radius: 50%;
  background: linear-gradient(135deg, #A91D1D 0%, #880015 100%);
}

.search-initial__category span {
  font-size: 11px;
  color: #333;
  text-align: center;
}

/* Sort & Filter Panel Styles (Same as Collection) */
.sort-panel,
.filter-panel {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  visibility: hidden;
  opacity: 0;
  transition: all 0.3s ease;
}

.sort-panel.is-open,
.filter-panel.is-open {
  visibility: visible;
  opacity: 1;
}

.sort-panel__overlay,
.filter-panel__overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
}

.sort-panel__content,
.filter-panel__content {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  max-height: 70vh;
  background: #fff;
  border-radius: 16px 16px 0 0;
  transform: translateY(100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.sort-panel.is-open .sort-panel__content,
.filter-panel.is-open .filter-panel__content {
  transform: translateY(0);
}

.sort-panel__header,
.filter-panel__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #E8E8E8;
}

.sort-panel__header h3,
.filter-panel__header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.sort-panel__close,
.filter-panel__close {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  cursor: pointer;
}

.sort-panel__close svg,
.filter-panel__close svg {
  width: 20px;
  height: 20px;
  color: #666;
}

.sort-panel__options {
  overflow-y: auto;
  padding: 8px 0;
}

.sort-panel__option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  text-decoration: none;
  color: #333;
  font-size: 14px;
  transition: background 0.2s;
}

.sort-panel__option:hover,
.sort-panel__option.is-active {
  background: #FFF5F5;
}

.sort-panel__option.is-active {
  color: #A91D1D;
  font-weight: 600;
}

.sort-panel__option svg {
  width: 20px;
  height: 20px;
  color: #A91D1D;
}

.filter-panel__body {
  flex: 1;
  overflow-y: auto;
}

.filter-group {
  border-bottom: 1px solid #E8E8E8;
}

.filter-group__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 16px 20px;
  font-size: 14px;
  font-weight: 600;
  color: #333;
  background: none;
  border: none;
  cursor: pointer;
}

.filter-group__header svg {
  width: 18px;
  height: 18px;
  color: #666;
  transition: transform 0.3s;
}

.filter-group.is-open .filter-group__header svg {
  transform: rotate(180deg);
}

.filter-group__options {
  display: none;
  padding: 0 20px 16px;
}

.filter-group.is-open .filter-group__options {
  display: block;
}

.filter-option {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 0;
  cursor: pointer;
}

.filter-option input {
  display: none;
}

.filter-option__checkbox {
  width: 20px;
  height: 20px;
  border: 2px solid #CCC;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.filter-option input:checked + .filter-option__checkbox {
  background: #A91D1D;
  border-color: #A91D1D;
}

.filter-option input:checked + .filter-option__checkbox::after {
  content: '✓';
  color: #fff;
  font-size: 12px;
  font-weight: 700;
}

.filter-option__label {
  font-size: 14px;
  color: #333;
}

.filter-panel__footer {
  display: flex;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid #E8E8E8;
}

.filter-panel__clear {
  flex: 1;
  padding: 14px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  background: #F5F5F5;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.filter-panel__apply {
  flex: 2;
  padding: 14px;
  font-size: 14px;
  font-weight: 600;
  color: #fff;
  background: #A91D1D;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.load-more__end {
  font-size: 13px;
  color: #999;
}
</style>

<script>
// FIX: Clear Search and Reset Page


// Sort Panel Functions
function openSortPanel() {
  document.getElementById('sortPanel').classList.add('is-open');
  document.body.style.overflow = 'hidden';
}

function closeSortPanel() {
  document.getElementById('sortPanel').classList.remove('is-open');
  document.body.style.overflow = '';
}

// Filter Panel Functions
function openFilterPanel() {
  document.getElementById('filterPanel').classList.add('is-open');
  document.body.style.overflow = 'hidden';
}

function closeFilterPanel() {
  document.getElementById('filterPanel').classList.remove('is-open');
  document.body.style.overflow = '';
}

function clearFilters() {
  document.querySelectorAll('.filter-option input').forEach(input => {
    input.checked = false;
  });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Load More functionality
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const productGrid = document.getElementById('productGrid');
  
  if (loadMoreBtn) {
    loadMoreBtn.addEventListener('click', loadMoreProducts);
    
    // Infinite scroll
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !loadMoreBtn.disabled) {
          loadMoreProducts();
        }
      });
    }, { rootMargin: '200px' });
    
    observer.observe(loadMoreBtn);
  }
  
  async function loadMoreProducts() {
    const nextUrl = loadMoreBtn.dataset.nextUrl;
    if (!nextUrl) return;
    
    loadMoreBtn.disabled = true;
    loadMoreBtn.querySelector('.load-more__text').style.display = 'none';
    loadMoreBtn.querySelector('.load-more__spinner').style.display = 'block';
    
    try {
      const response = await fetch(nextUrl);
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      const newProducts = doc.querySelectorAll('.product-grid--crimson .crimson-card');
      
      newProducts.forEach((product, index) => {
        product.style.setProperty('--card-index', productGrid.children.length + index);
        productGrid.appendChild(product.cloneNode(true));
      });
      
      const newLoadMore = doc.querySelector('#loadMoreBtn');
      if (newLoadMore && newLoadMore.dataset.nextUrl) {
        loadMoreBtn.dataset.nextUrl = newLoadMore.dataset.nextUrl;
        loadMoreBtn.disabled = false;
        loadMoreBtn.querySelector('.load-more__text').style.display = '';
        loadMoreBtn.querySelector('.load-more__spinner').style.display = 'none';
      } else {
        document.getElementById('loadMoreContainer').innerHTML = 
          '<p class="load-more__end">You\'ve seen all results</p>';
      }
      
      initWishlistButtons();
      
    } catch (error) {
      console.error('Error loading more products:', error);
      loadMoreBtn.disabled = false;
      loadMoreBtn.querySelector('.load-more__text').style.display = '';
      loadMoreBtn.querySelector('.load-more__spinner').style.display = 'none';
    }
  }
  
  // Wishlist buttons
  function initWishlistButtons() {
    document.querySelectorAll('.crimson-card__wishlist').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.toggle('is-active');
        
        const productId = this.dataset.productId;
        const isActive = this.classList.contains('is-active');
        
        let wishlist = JSON.parse(localStorage.getItem('aona_wishlist') || '[]');
        if (isActive) {
          if (!wishlist.includes(productId)) wishlist.push(productId);
        } else {
          wishlist = wishlist.filter(id => id !== productId);
        }
        localStorage.setItem('aona_wishlist', JSON.stringify(wishlist));
      });
    });
    
    const wishlist = JSON.parse(localStorage.getItem('aona_wishlist') || '[]');
    wishlist.forEach(productId => {
      const btn = document.querySelector(`.crimson-card__wishlist[data-product-id="${productId}"]`);
      if (btn) btn.classList.add('is-active');
    });
  }
  
  initWishlistButtons();
  
  // Quick category search
  document.querySelectorAll('.filter-bar__category').forEach(btn => {
    btn.addEventListener('click', function() {
      const search = this.dataset.search;
      window.location.href = '/search?q=' + search + '&type=product';
    });
  });
});
</script>

{% schema %}
{
  "name": "Search Results",
  "tag": "section",
  "class": "section-search",
  "settings": [
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 24,
      "step": 4,
      "default": 12,
      "label": "Products per page"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": true,
      "label": "Show vendor"
    }
  ]
}
{% endschema %}
